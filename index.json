import express from "express";
import axios from "axios";
import { Telegraf } from "telegraf";

// ===== BOT CONFIG =====
const bot = new Telegraf("8129553539:AAHewTVqBZNOg-XbCdIDMjrFWFZJtvn1hKQ"); // Telegram Token
const GROQ_API_KEY = "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";

// ===== MEMORY =====
const userMemory = {};
const MEMORY_LIMIT = 5;

// ===== HELPER: Ask Groq =====
async function askGroq(messages) {
  const res = await axios.post(
    "https://api.groq.com/openai/v1/chat/completions",
    { model: "llama-3.1-70b-versatile", messages },
    { headers: { Authorization: `Bearer ${GROQ_API_KEY}` } }
  );
  return res.data.choices[0].message.content;
}

// ===== MEMORY =====
function addToMemory(chatId, msg) {
  if (!userMemory[chatId]) userMemory[chatId] = [];
  userMemory[chatId].push(msg);
  if (userMemory[chatId].length > MEMORY_LIMIT) userMemory[chatId].shift();
}
function getMemoryMessages(chatId) {
  return userMemory[chatId]?.map((text) => ({ role: "user", content: text })) || [];
}

// ===== /start =====
bot.start((ctx) => {
  ctx.reply(
    `ðŸ‘‹ à¦¹à§à¦¯à¦¾à¦²à§‹! à¦†à¦®à¦¿ *ShGPT*\nà¦†à¦®à¦¿ à¦¬à¦¾à¦‚à¦²à¦¾, à¦›à¦¬à¦¿, à¦­à§Ÿà§‡à¦¸ à¦à¦¬à¦‚ à¦¡à¦•à§à¦®à§‡à¦¨à§à¦Ÿ à¦¬à§à¦à¦¤à§‡ à¦ªà¦¾à¦°à¦¿à¥¤\n\nðŸ”¥ à¦¶à§à¦°à§ à¦•à¦°à¦¤à§‡ à¦•à¦¿à¦›à§ à¦²à¦¿à¦–à§‡ à¦ªà¦¾à¦ à¦¾à¦“à¥¤`,
    { parse_mode: "Markdown" }
  );
});

// ===== /image COMMAND =====
bot.command("image", async (ctx) => {
  const prompt = ctx.message.text.replace("/image", "").trim();
  if (!prompt) return ctx.reply("âŒ à¦›à¦¬à¦¿ à¦¬à¦¾à¦¨à¦¾à¦¨à§‹à¦° à¦œà¦¨à§à¦¯ à¦•à¦¿à¦›à§ à¦²à¦¿à¦–à§‹à¥¤");
  ctx.reply("ðŸŽ¨ à¦›à¦¬à¦¿ à¦¤à§ˆà¦°à¦¿ à¦¹à¦šà§à¦›à§‡...");

  try {
    const res = await axios.post(
      "https://api.groq.com/openai/v1/images/generate",
      { prompt, size: "1024x1024" },
      { headers: { Authorization: `Bearer ${GROQ_API_KEY}` } }
    );
    ctx.reply(res.data.data[0].url);
  } catch {
    ctx.reply("âŒ à¦›à¦¬à¦¿ à¦¤à§ˆà¦°à¦¿ à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡!");
  }
});

// ===== TEXT MESSAGE =====
bot.on("text", async (ctx) => {
  const chatId = ctx.chat.id;
  const text = ctx.message.text;

  addToMemory(chatId, text);
  ctx.reply("ðŸ¤– ShGPT à¦²à¦¿à¦–à¦›à§‡...");

  try {
    const messages = [
      { role: "system", content: "You are ShGPT, a friendly Bangla chatbot." },
      ...getMemoryMessages(chatId).map((msg) => ({ role: "user", content: msg })),
    ];
    const reply = await askGroq(messages);
    ctx.reply(reply);
  } catch {
    ctx.reply("âŒ à¦•à¦¿à¦›à§ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡!");
  }
});

// ===== PHOTO =====
bot.on("photo", async (ctx) => {
  ctx.reply("ðŸ“· à¦›à¦¬à¦¿ à¦¬à¦¿à¦¶à§à¦²à§‡à¦·à¦£ à¦•à¦°à¦›à¦¿...");
  const fileId = ctx.message.photo.pop().file_id;
  const file = await ctx.telegram.getFileLink(fileId);
  const reply = await askGroq([{ role: "user", content: `à¦à¦‡ à¦›à¦¬à¦¿à¦Ÿà¦¾ à¦¬à¦°à§à¦£à¦¨à¦¾ à¦•à¦°à§‹: ${file.href}` }]);
  ctx.reply(reply);
});

// ===== DOCUMENT =====
bot.on("document", async (ctx) => {
  ctx.reply("ðŸ“„ à¦¡à¦•à§à¦®à§‡à¦¨à§à¦Ÿ à¦ªà§à¦°à¦¸à§‡à¦¸ à¦•à¦°à¦›à¦¿...");
  const fileId = ctx.message.document.file_id;
  const file = await ctx.telegram.getFileLink(fileId);
  const reply = await askGroq([{ role: "user", content: `à¦¡à¦•à§à¦®à§‡à¦¨à§à¦Ÿà¦Ÿà¦¿ à¦ªà§œà§‹ à¦à¦¬à¦‚ à¦¸à¦¾à¦°à¦¾à¦‚à¦¶ à¦¬à¦¾à¦¨à¦¾à¦“: ${file.href}` }]);
  ctx.reply(reply);
});

// ===== VOICE =====
bot.on("voice", async (ctx) => {
  ctx.reply("ðŸŽ¤ à¦­à§Ÿà§‡à¦¸ à¦ªà§à¦°à¦¸à§‡à¦¸ à¦¹à¦šà§à¦›à§‡...");
  const fileId = ctx.message.voice.file_id;
  const file = await ctx.telegram.getFileLink(fileId);
  const reply = await askGroq([{ role: "user", content: `à¦à¦‡ à¦­à§Ÿà§‡à¦¸ à¦…à¦¡à¦¿à¦“ à¦¶à§à¦¨à§‡ à¦²à¦¿à¦–à§‹: ${file.href}` }]);
  ctx.reply(reply);
});

// ===== EXPRESS SERVER FOR WEBHOOK =====
const app = express();
app.use(bot.webhookCallback("/webhook"));
app.get("/", (req, res) => res.send("ShGPT Bot is running!"));
app.listen(3000, () => console.log("ShGPT server started"));
